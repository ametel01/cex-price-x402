name: CI

on:
  pull_request:
  push:
    branches: [main]

concurrency:
  group: ci-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  ci:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: 1.3.1

      - name: Cache bun cache and node_modules
        uses: actions/cache@v4
        with:
          path: |
            ~/.bun/install/cache
            node_modules
          key: ${{ runner.os }}-bun-${{ hashFiles('bun.lock') }}
          restore-keys: |
            ${{ runner.os }}-bun-

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Type check
        run: bun run type-check

      - name: Format check
        run: bun run format:check

      - name: Lint
        run: bun run lint -- --max-warnings=0

      - name: Unit tests
        run: bun test --coverage 2>&1 | tee coverage-output.txt
        env:
          NODE_ENV: test
          PORT: 8080
          RESOURCE_WALLET_ADDRESS: "0x0000000000000000000000000000000000000000"
          PRIVATE_KEY: "0x0000000000000000000000000000000000000000000000000000000000000000"
          NETWORK: base-sepolia
          FACILITATOR_URL: http://localhost:8080/facilitator
          PAIRS: BTC-USD,ETH-USD
          SPREAD_BPS_MAX: 25
          STALE_MS: 2000

      - name: Extract coverage percentage
        id: coverage
        run: |
          echo "=== Debug: Checking coverage-output.txt ==="
          if [ -f coverage-output.txt ]; then
            echo "File exists, size: $(wc -l coverage-output.txt)"
            echo "=== First 20 lines ==="
            head -20 coverage-output.txt
            echo "=== Lines with 'files' ==="
            grep -i "files" coverage-output.txt || echo "No 'files' found"
            echo "=== Attempting extraction ==="
          else
            echo "ERROR: coverage-output.txt not found!"
          fi

          COVERAGE=$(grep "All files" coverage-output.txt | awk -F'|' '{print $3}' | tr -d ' ' || echo "")

          if [ -z "$COVERAGE" ]; then
            echo "Failed with method 1, trying alternative..."
            COVERAGE=$(grep -i "all files" coverage-output.txt | sed -n 's/.*|\s*\([0-9.]*\)\s*|\s*\([0-9.]*\)\s*|.*/\2/p' || echo "")
          fi

          if [ -z "$COVERAGE" ]; then
            echo "WARNING: Could not extract coverage, using 0"
            COVERAGE="0"
          fi

          echo "percentage=$COVERAGE" >> $GITHUB_OUTPUT
          echo "Final coverage: $COVERAGE%"

      - name: Create coverage badge
        if: github.ref == 'refs/heads/main'
        continue-on-error: true
        uses: schneegans/dynamic-badges-action@v1.7.0
        with:
          auth: ${{ secrets.GIST_SECRET }}
          gistID: 7612b07cbc433f6b5339e3728f5b88d6
          filename: coverage.json
          label: coverage
          message: ${{ steps.coverage.outputs.percentage }}%
          color: ${{ steps.coverage.outputs.percentage > 80 && 'green' || steps.coverage.outputs.percentage > 60 && 'yellow' || 'red' }}

      - name: Upload coverage output
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-output
          path: coverage-output.txt
          retention-days: 7

      - name: Build
        run: bun run build
        env:
          NODE_ENV: production
          PORT: 8080
          RESOURCE_WALLET_ADDRESS: "0x0000000000000000000000000000000000000000"
          NETWORK: base-sepolia
          FACILITATOR_URL: http://localhost:8080/facilitator
          PAIRS: BTC-USD,ETH-USD
          SPREAD_BPS_MAX: 25
          STALE_MS: 2000

      - name: Upload dist
        uses: actions/upload-artifact@v4
        with:
          name: dist
          path: dist/
          retention-days: 7
